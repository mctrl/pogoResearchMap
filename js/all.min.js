var map=null;function initialize(){var defaultCenter=new google.maps.LatLng(52.92219,-1.47751);var defaultZoom=13;var tableId="1_s6-uXU08BcUETuUwdg7DTBfvXc6CDHFeqNnqlXR";var locationColumn="location";var geocoder=new google.maps.Geocoder;var centered=0;map=new google.maps.Map(document.getElementById("map-canvas"),{center:defaultCenter,zoom:defaultZoom,mapTypeId:google.maps.MapTypeId.ROADMAP,gestureHandling:"greedy",streetViewControl:false,fullscreenControl:false,zoomControl:false,mapTypeControl:false});if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(position){var pos={lat:position.coords.latitude,lng:position.coords.longitude};var currentPosMarker=new google.maps.Marker({position:pos,animation:google.maps.Animation.DROP,map:map,icon:"https://i.imgur.com/lvHhrEf.png"});if(centered===0){map.setCenter(pos);navigator.geolocation.watchPosition(function(position){var pos1={lat:position.coords.latitude,lng:position.coords.longitude};currentPosMarker.setPosition(pos1)});centered=1}else{}})}else{alert("Geolocation is not supported for this Browser/OS.")}var layer=new google.maps.FusionTablesLayer({query:{select:locationColumn,from:tableId},map:map,styleId:2,templateId:2});var query="SELECT 'Task Name', 'Reward' FROM "+"1mlP-EhLtoaiGR24ChXSgdYbO2h7ZapUjMADXmcPc";var encodedQuery=encodeURIComponent(query);var url=["https://www.googleapis.com/fusiontables/v1/query"];url.push("?sql="+encodedQuery);url.push("&key=AIzaSyAm9yWCV7JPCTHCJut8whOjARd7pwROFDQ");url.push("&callback=?");var dataElement=document.createElement("select");var taskSubmit=document.getElementById("Research Task");dataElement.style="display:block; margin:auto; width:100%";dataElement.id="taskList";var starter=document.createElement("option");var taskSubmitInner=document.createElement("option");starter.innerHTML="Filter Visible Research Tasks";starter.value="All";taskSubmitInner.innerHTML="None Selected";taskSubmitInner.value="All";dataElement.appendChild(starter);taskSubmit.appendChild(taskSubmitInner);$.ajax({url:url.join(""),dataType:"jsonp",success:function(data){var rows=data["rows"];var ftData=document.getElementById("ft-data");for(var i in rows){var store=rows[i][0];var reward=rows[i][1];var storeElement=document.createElement("option");var TaskSubmitInner=document.createElement("option");storeElement.innerHTML=store+" : "+reward;storeElement.value=store;storeElement.setAttribute("data-reward",reward);TaskSubmitInner.innerHTML=store;TaskSubmitInner.value=store;TaskSubmitInner.setAttribute("data-reward",reward);dataElement.appendChild(storeElement);ftData.appendChild(dataElement);taskSubmit.appendChild(TaskSubmitInner)}}});var zoomToAddress=function(){var address=document.getElementById("address").value;geocoder.geocode({address:address},function(results,status){if(status==google.maps.GeocoderStatus.OK){map.setCenter(results[0].geometry.location);map.setZoom(13);var sw=map.getBounds().getSouthWest();var ne=map.getBounds().getNorthEast();var where="ST_INTERSECTS("+locationColumn+", RECTANGLE(LATLNG"+sw+", LATLNG"+ne+"))";layer.setOptions({query:{select:locationColumn,from:tableId,where:where}})}else{window.alert("Address could not be geocoded: "+status)}})};function updateMap(layer,tableId,locationColumn){var selectBox=document.getElementById("taskList").value;if(selectBox!="All"){layer.setOptions({query:{select:locationColumn,from:tableId,where:"'Research Task'='"+selectBox+"'"}})}else{layer.setOptions({query:{select:locationColumn,from:tableId}})}}google.maps.event.addDomListener(document.getElementById("search"),"click",zoomToAddress);google.maps.event.addDomListener(window,"keypress",function(e){if(e.keyCode==13){zoomToAddress()}});google.maps.event.addDomListener(document.getElementById("reset"),"click",function(){map.setCenter(defaultCenter);map.setZoom(defaultZoom);layer.setOptions({query:{select:locationColumn,from:tableId}})});setTimeout(function(){google.maps.event.addDomListener(document.getElementById("taskList"),"change",function(){updateMap(layer,tableId,locationColumn)});var researchSelector=document.getElementById("Research Task");researchSelector.onchange=function(){var reward=document.getElementById("Reward");reward.value=researchSelector.options[researchSelector.selectedIndex].dataset.reward};var items=[];$.getJSON("https://spreadsheets.google.com/feeds/list/1wy864L-zL-iSRo48D_WbcUP1nZSrCb-3RjpqXk-hDfY/od6/public/basic?alt=json",function(data){$.each(data,function(key,val){$.each(val.entry,function(key2,val2){items.push(val2.title.$t)});$("#stop").autocomplete({source:items,open:function(event,ui){var $input=$(event.target),$results=$input.autocomplete("widget"),top=$results.position().top,height=$results.height(),inputHeight=$input.height(),newTop=top-height-inputHeight;$results.css("top",newTop+"px")}})})})},2e3)}google.maps.event.addDomListener(window,"load",initialize);var request;var gmarkers=[];function Pushbullet(){PushBullet.APIKey="o.HvSM73Nce2NTazVaVFVTMHcakiBDnZQ1";var all=PushBullet.devices();var device=all.devices[0].iden;var task=document.getElementById("Research Task");var theMessage=PushBullet.push("note",null,null,{title:"New Research Task",body:task.value})}function getLocation(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(showPosition);$.notify("Getting Location please wait ...",{position:"right middle",style:"bootstrap",className:"warning"})}else{x.innerHTML="Geolocation is not supported by this browser."}}function showPosition(position){var marker=null;for(i=0;i<gmarkers.length;i++){gmarkers[i].setMap(null)}var location=document.getElementById("location");var thePosition=new google.maps.LatLng(position.coords.latitude,position.coords.longitude);location.value=position.coords.latitude+","+position.coords.longitude;marker=new google.maps.Marker({position:thePosition,map:map,draggable:true,animation:google.maps.Animation.DROP,title:"Your location",icon:"https://i.imgur.com/Dsi21Fi.png"});map.setCenter(thePosition);map.setZoom(17);gmarkers.push(marker);google.maps.event.addListener(marker,"dragend",function(evt){location.value=evt.latLng.lat().toFixed(5)+","+evt.latLng.lng().toFixed(5)});google.maps.event.addListener(marker,"dragstart",function(evt){location.value="Currently dragging marker"})}$(".hideshow").on("click",function(){$(".TaskSubmitter").stop(true,true).slideToggle().toggleClass("opened");var isVisible=$(".TaskSubmitter").is(".opened");if(isVisible===true){getLocation()}else{}});$("#foo").submit(function(event){event.preventDefault();var research_task=document.getElementById("Research Task").value;if(research_task=="All"){$.notify("Please Choose a Task from the List",{position:"right middle",style:"bootstrap",className:"error"})}else{if(request){request.abort()}var $form=$(this);var $inputs=$form.find("Research Task,Reward, location,stop");var serializedData=$form.serialize();$inputs.prop("disabled",true);request=$.ajax({url:"https://script.google.com/macros/s/AKfycbww5kraaGA3JNaMvl0TqWUiJRm4NcquT_E_Sy8zifxjbMTXjkPq/exec",type:"post",data:serializedData});$.notify("Posting Task please wait...",{position:"right middle",style:"bootstrap",className:"success",autoHideDelay:1500});request.done(function(response,textStatus,jqXHR){$.notify("Research Task Submitted for Approval",{position:"right middle",style:"bootstrap",className:"success"});var Research_task_selector=document.getElementById("Research Task");var reward=document.getElementById("Reward");reward.value=Research_task_selector.options[Research_task_selector.selectedIndex].dataset.reward;Pushbullet()});request.fail(function(jqXHR,textStatus,errorThrown){console.error("The following error occurred: "+textStatus,errorThrown)});request.always(function(){$inputs.prop("disabled",false)})}});